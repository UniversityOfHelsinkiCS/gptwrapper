<div translate="yes" lang="fi" style="position: relative;">
  <iframe
    id="cc-iframe"
    src="https://curre.helsinki.fi/chat/toska?embedded=true&amp;promptId=459cd6c8-2c65-4196-9c0b-0d469f254ddb"
    width="100%" height="500px">
  </iframe>
  <div id="login-popup-info" style="position: absolute; top: 0; left: 0; display: none; padding: 4rem; white-space: pre-line;">
    <p>Sinun pitää uudistaa kirjautumissessiosi käyttääksesi CurreChattiä. 
      Kirjautuminen avautuu uuteen ikkunaan. 
      Jos niin ei tapahtunut, <a href="https://curre.helsinki.fi/chat" target="_blank" rel="opener">paina tästä</a>.
    </p>
    <p id="popup-blocked-info" style="display: none; margin-top: 1rem;">
      Ponnahdusikkunaa ei voitu avata, joten käytä yllä olevaa linkkiä.
    </p>
  </div>
  <script>

    /**
     * @type {HTMLIFrameElement}
    */
    const iframe = document.getElementById("cc-iframe")
    let successLoading = false

    iframe.onload = async () => {
      if (successLoading) {
        console.log("Iframe already loaded successfully, skipping")
        return
      }
      // Listen for a pong message from the iframe

      window.addEventListener("message", function handler(event) {
        if (event.origin !== "https://curre.helsinki.fi") {
          return
        }

        console.log("Received message", event.data)

        if (event.data.type === 'pong') {
          successLoading = true
          console.log("Pong message received, iframe loaded successfully")
          window.removeEventListener("message", handler)
          document.getElementById("login-popup-info").style.display = "none"
        }
      })

      iframe.contentWindow?.postMessage({ type: "ping" }, "https://curre.helsinki.fi")
      await new Promise((resolve) => setTimeout(resolve, 1000))

      if (successLoading) {
        console.log("Iframe responded, no need to login")
        return
      }
      console.log("No response from iframe, opening login popup")

      // Open CC in a new window and do a handshake with it

      document.getElementById("login-popup-info").style.display = "block"

      const windowProxy = window.open("https://curre.helsinki.fi/chat/login-helper", "_blank", "width=600,height=400,rel=opener")
      if (!windowProxy) {
        document.getElementById("popup-blocked-info").style.display = "block"
      }

      // Listen for message from the popup window

      const nonce = crypto.randomUUID()

      window.addEventListener("message", function handler(event) {
        if (event.origin !== "https://curre.helsinki.fi") {
          return
        }

        console.log("Received message", event.data)

        if (event.data.type === "login-success" && event.data.nonce === nonce) {
          // Reload the iframe to reflect the new login state
          console.log("Login success message received with correct nonce", nonce)
          successLoading = true
          iframe.src = iframe.src
          document.getElementById("login-popup-info").style.display = "none"
          windowProxy?.close()
          window.removeEventListener("message", handler)
        }
      })

      window.addEventListener("beforeunload", () => {
        windowProxy?.close()
      })

      window.addEventListener("focus", function handler() {
        // Reload the iframe to reflect the new login state
        iframe.src = iframe.src
        document.getElementById("login-popup-info").style.display = "none"
        windowProxy?.close()
      })

      await new Promise((resolve) => setTimeout(resolve, 1000))
      
      console.log("Sending login-query message with nonce", nonce)
      windowProxy?.postMessage({ type: "login-query", nonce }, "https://curre.helsinki.fi")
    }
  </script>
</div>
